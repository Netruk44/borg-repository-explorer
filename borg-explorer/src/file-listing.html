<!DOCTYPE html>
<html>
  <head>
    <title>Borg Repository Listing</title>
    <!--<link rel="stylesheet" type="text/css" href="style.css">-->
    <link rel="stylesheet" type="text/css" href="file-listing.css">
  </head>
  <body>
  </body>
  <script type="text/javascript">
    const { ipcRenderer } = parent.require('electron');
    const moment = parent.require('./lib/moment');
    const prettyBytes = parent.require('./lib/pretty-bytes');

    var currentRepoPath = null;
    var currentRepoPass = null;
    var currentRepoArchive = null;
    var currentNavigationPath = null;

    /**************************************************************************
     * Local Window Helpers
     **************************************************************************/
    function clear() {
      document.body.innerHTML = '';
    }

    function navigateArchive(relativePath = '.') {
      // Navigate to the given path in the repository.
      // If no path is given, navigate to the root of the repository.
      //ipcRenderer.send('list-archive', currentRepoPath, currentRepoPass, relativePath);
      console.log(`Navigating to ${relativePath}`);
      return; // TODO
    }

    function openArchive(archiveName) {
      // Open the given archive.
      console.log(`Opening archive ${archiveName}`);
      currentRepoArchive = archiveName;
      currentNavigationPath = null; // Get entire archive.
      //currentNavigationPath = ''; // Get root folder
      ipcRenderer.send('list-archive', currentRepoPath, currentRepoPass, archiveName, currentNavigationPath);
    }

    function openFile(relativePath) {
      // Open the given file.
      console.log(`Opening file ${relativePath}`);
      return; // TODO
    }

    /**************************************************************************
     * Parent Window Communication
     **************************************************************************/
    function openRepository(data) {
      currentRepoPath = data.path;
      currentRepoPass = data.passphrase;

      // Open archive
      document.body.innerHTML = `<h2>Opening archive ${currentRepoPath}</h1>`;
      ipcRenderer.send('list-repository', currentRepoPath, currentRepoPass);
    }

    ipcRenderer.on('list-repository-result', (event, data) => {
      //document.body.innerHTML = `${JSON.stringify(data)}}`;
      clear();

      /* Data is an object that looks like:
      {
        "archives": [
          {
            "archive": "<archive-name>",
            "barchive": "<archive-name>",
            "id": "<archive-id>",
            "start": "<start-time>",
            "time": "<end-time>",
          },
          {
          },
        ],
        "encryption": {
          "mode": "repokey-blake2"
        },
        "repository": {
          "id": "",
          "location": "",
        }
      }*/

      // Create a header with the repository location and ID.
      var repoMetadata = document.createElement('div');
      repoMetadata.classList.add('repo-info');
      repoMetadata.innerHTML = `
        <h2>Listing for repository "${data.repository.location.split('/').pop()}"</h2>
        <strong>Repository ID:</strong> ${data.repository.id}<br>
        <strong>Location:</strong> ${data.repository.location}`;
      document.body.appendChild(repoMetadata);

      // Create a list of archives with links to open them.
      // Links will call navigateRepo with the archive name.
      // Next to the links there will be a description using the time the archive was created.
      var archiveList = document.createElement('ul');
      for (var archive of data.archives) {
        var archiveItem = document.createElement('li');
        var archiveLink = document.createElement('a');
        archiveLink.classList.add('archive-link');
        archiveLink.innerHTML = archive.archive;
        archiveLink.href = '#';
        
        // TODO (assumed): Fix all links referencing the final archive.
        archiveLink.addEventListener('click', () => {
          openArchive(archive.archive);
        });
        archiveItem.appendChild(archiveLink);
        var archiveDescription = document.createElement('span');
        archiveDescription.classList.add('archive-description');
        // Use moment to show the archive time and display age.
        archiveDescription.innerHTML = ` - ${moment(archive.time)} (${moment(archive.time).fromNow()})`;
        archiveItem.appendChild(archiveDescription);
        archiveList.appendChild(archiveItem);
      }

      document.body.appendChild(archiveList);
    });

    ipcRenderer.on('list-archive-result', (event, data) => {
      //document.body.innerHTML = `${JSON.stringify(data)}}`;
      clear();

      /* Data is an object that looks like:
      [{
        "type":"d", // d for directory, - for file
        "mode":"drwxr-xr-x",
        "user":"danielperry",
        "group":"staff",
        "uid":501,
        "gid":20,
        "path":"Users/danielperry/Desktop/borg-explorer-repo/backup",
        "healthy":true,
        "source":"",
        "linktarget":"",
        "flags":0,
        "mtime":"2022-11-04T00:49:44.110426",
        "size":0
      },
      {...}, ...]*/

      // Create a header with the archive name and current path.
      var archiveMetadata = document.createElement('div');
      archiveMetadata.classList.add('archive-info');
      archiveMetadata.innerHTML = `
        <h2>Listing for archive "${currentRepoArchive}"</h2>
        <strong>Current Path:</strong> ${currentNavigationPath}`;
      document.body.appendChild(archiveMetadata);

      // Create a list of files and directories with links to open them.
      // Links to directories will call navigateArchive with the relative path.
      // Links to files will call openFile with the relative path.
      // Next to the links there will be a description using the time the file was modified.
      var fileList = document.createElement('ul');
      for (var file of data) {
        var fileItem = document.createElement('li');
        var fileLink = document.createElement('a');
        fileLink.classList.add('file-link');
        fileLink.innerHTML = file.path.split('/').pop();
        fileLink.href = '#';

        // TODO: Fix all links referencing the final file.
        if (file.type == 'd') {
          fileLink.addEventListener('click', () => {
            navigateArchive(file.path);
          });
        }
        else {
          fileLink.addEventListener('click', () => {
            openFile(file.path);
          });
        }
        fileItem.appendChild(fileLink);
        var fileDescription = document.createElement('span');
        fileDescription.classList.add('file-description');

        // If the entry is a directory, show modified time and age
        // If the entry is a file, show size (using prettyBytes), modified time and age.
        if (file.type == 'd') {
          fileDescription.innerHTML = ` - <span class='file-date'>${moment(file.mtime)} (${moment(file.mtime).fromNow()})</span>`;
        }
        else {
          //fileDescription.innerHTML = ` - ${file.size} bytes, ${moment(file.mtime)} (${moment(file.mtime).fromNow()})`;
          fileDescription.innerHTML = ` - <span class='file-size'>${prettyBytes(file.size)}</span>, <span class='file-date'>${moment(file.mtime)} (${moment(file.mtime).fromNow()})</span>`;
        }
        fileItem.appendChild(fileDescription);
        fileList.appendChild(fileItem);
      }

      document.body.appendChild(fileList);
    });

    const knownFunctions = {
      'open': openRepository,
    };

    window.addEventListener('message', (event) => {
      // Received a message from the parent window.
      // Check if we're aware of the command we've received.
      if (event.data.command in knownFunctions) {
        // Known function, forward the data to the function
        knownFunctions[event.data.command](event.data);
      }
      else {
        console.error(`Unknown command sent to file listing: ${event.data.command}`);
      }
    })
  </script>
</html>
